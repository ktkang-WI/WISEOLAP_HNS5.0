<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wise.MarketingPlatForm.report.dao.ReportDAO">
  <!-- Mapper -->
  <resultMap id="ReportList" type="com.wise.MarketingPlatForm.report.entity.ReportListEntity">
		<result column="ID" property="id" javaType="int"/>
    <result column="TEXT" property="name" javaType="String"/>
    <result column="UPPERID" property="upperId" javaType="int"/>
    <result column="ORDINAL" property="ordinal" javaType="int"/>
    <result column="REPORT_TYPE" property="reportType" javaType="String"/>
    <result column="TYPE" property="type" javaType="String"/>
	</resultMap>
  <!-- Query -->
    <select id="selectReport" parameterType="String" resultType="com.wise.MarketingPlatForm.report.entity.ReportMstrEntity">
        SELECT 	A.REPORT_ID as reportId
				, A.REPORT_NM as reportNm
				, A.FLD_ID as fldId   
				, A.FLD_TYPE as fldType
				, A.REPORT_ORDINAL as reportOrdinal
				, A.REPORT_TYPE as reportType
				, A.REPORT_TAG as reportTag
				, A.REPORT_DESC as reportDesc
				, A.REPORT_LAYOUT as reportLayout
				, A.GRID_INFO as gridInfo
				, A.DATASRC_ID as datasrcId
				, A.DATASRC_TYPE as datasrcType
				, A.DATASET_TYPE as datasetType
				, A.REPORT_XML as reportXml
				, A.CHART_XML as chartXml
				, A.LAYOUT_XML as layoutXml
				, A.DATASET_XML as datasetXml
				, A.PARAM_XML as paramXml
				, A.DATASET_QUERY as datasetQuery
				, A.DEL_YN as delYn
				, A.REG_USER_NO as regUserNo
				, B.USER_NM AS RegUserNm
				, A.REG_DT as regDt
				, A.PROMPT_YN as promptYn
				, A.REPORT_SUB_TITLE as reportSubTitle
				, A.MOD_USER_NO as modUserNo
				, C.USER_NM AS modUserNm							
				, A.MOD_DT as modDt
				, B.USER_NM as userNm
				, A.PRIVACY_YN as privacyYn
            FROM 	REPORT_MSTR A
				LEFT OUTER JOIN USER_MSTR B ON A.REG_USER_NO = B.USER_NO
				LEFT OUTER JOIN USER_MSTR C ON A.MOD_USER_NO = C.USER_NO
            WHERE   1=1
            AND		A.DEL_YN = 'N'
            <if test='reportId != null'>
                AND A.REPORT_ID = #{reportId}
            </if>
    </select>

    <select id="selectPublicReportList" resultMap="ReportList">
        SELECT 	DISTINCT ID,
            TEXT,
            UPPERID,
            ORDINAL,
            REPORT_TYPE,
            TYPE,
            REG_DT
        FROM ((SELECT DISTINCT 	PUB_FLD_MSTR.FLD_ID				AS ID,
                      PUB_FLD_MSTR.FLD_NM				AS TEXT,
                            PUB_FLD_MSTR.FLD_PARENT_ID 		AS UPPERID,
                            PUB_FLD_MSTR.FLD_ORDINAL   		AS ORDINAL,
                            NULL 							AS REPORT_TYPE,
                            'FOLDER'                   		AS TYPE,
                            NULL						  	AS REG_DT
              FROM   				USER_AUTH_REPORT_MSTR
            INNER JOIN 			USER_MSTR 						ON USER_MSTR.USER_NO = USER_AUTH_REPORT_MSTR.USER_NO
            INNER JOIN 			PUB_FLD_MSTR 					ON PUB_FLD_MSTR.FLD_ID = USER_AUTH_REPORT_MSTR.FLD_ID
            <if test='editMode == "designer"'>
              WHERE  				USER_MSTR.USER_ID = #{userId}
              AND 				AUTH_PUBLISH != 'N'
            </if>
            <if test='editMode == "viewer"'>
              WHERE  				USER_MSTR.USER_ID = #{userId}
              AND 				AUTH_VIEW != 'N'
            </if>
            )
                UNION ALL
              (SELECT DISTINCT 	PUB_FLD_MSTR.FLD_ID        		AS ID,
                            PUB_FLD_MSTR.FLD_NM       		AS TEXT,
                            PUB_FLD_MSTR.FLD_PARENT_ID 		AS UPPERID,
                            PUB_FLD_MSTR.FLD_ORDINAL   		AS ORDINAL,
                            NULL 							AS REPORT_TYPE,
                            'FOLDER'                  	 	AS TYPE,
                            NULL						  	AS REG_DT
            FROM   				GRP_AUTH_REPORT_MSTR
            INNER JOIN 			USER_MSTR 						ON USER_MSTR.GRP_ID = GRP_AUTH_REPORT_MSTR.GRP_ID
            INNER JOIN 			PUB_FLD_MSTR 					ON PUB_FLD_MSTR.FLD_ID = GRP_AUTH_REPORT_MSTR.FLD_ID
            <if test='editMode == "designer"'>
              WHERE  				USER_MSTR.USER_ID = #{userId}
              AND 				AUTH_PUBLISH != 'N'
            </if>
            <if test='editMode == "viewer"'>
              WHERE  				USER_MSTR.USER_ID = #{userId}
              AND 				AUTH_VIEW != 'N'
            </if>
            )
              UNION ALL
            (SELECT 			REPORT_MSTR.REPORT_ID			AS ID,
                          REPORT_MSTR.REPORT_NM			AS TEXT,
                      REPORT_MSTR.FLD_ID 				AS UPPERID,
                          REPORT_MSTR.REPORT_ORDINAL 		AS ORDINAL,
                          REPORT_MSTR.REPORT_TYPE 		AS REPORT_TYPE,
                          'REPORT'           				AS TYPE,
                          REPORT_MSTR.REG_DT				AS REG_DT
            FROM   				REPORT_MSTR
            INNER JOIN 			PUB_FLD_MSTR 					ON REPORT_MSTR.FLD_ID = PUB_FLD_MSTR.FLD_ID
            WHERE  				REPORT_MSTR.DEL_YN != 'Y'
        <if test="reportTypes != null">
            AND 				REPORT_MSTR.REPORT_TYPE IN 
            <foreach collection="reportTypes" item="type" open="(" close=")" separator=",">
             #{type}
            </foreach>
        </if>
        ) ) A
        ORDER BY UPPERID, TYPE, ORDINAL
    </select>

    <select id="selectPrivateReportList" resultMap="ReportList">
      SELECT *
      FROM  (( SELECT DISTINCT USER_FLD_MSTR.FLD_ID       AS ID,
                     USER_FLD_MSTR.FLD_NM        			AS TEXT,
                     USER_FLD_MSTR.FLD_PARENT_ID 			AS UPPERID,
                     USER_FLD_MSTR.FLD_ORDINAL   			AS ORDINAL,
                     NULL 								AS REPORT_TYPE,
                     'FOLDER'                   			AS TYPE,
                   NULL						  			AS REG_DT
              FROM   USER_FLD_MSTR
                     INNER JOIN USER_MSTR
                             ON USER_MSTR.USER_NO = USER_FLD_MSTR.USER_NO
              WHERE  USER_MSTR.USER_ID = #{userId}
                )
             UNION ALL
             (SELECT REPORT_MSTR.REPORT_ID          		AS ID,
                     REPORT_MSTR.REPORT_NM          		AS TEXT,
                     REPORT_MSTR.FLD_ID 					AS UPPERID,
                     REPORT_MSTR.REPORT_ORDINAL     		AS ORDINAL,
                     REPORT_MSTR.REPORT_TYPE 				AS REPORT_TYPE,
                     'REPORT'           					AS TYPE,
                 REPORT_MSTR.REG_DT					AS REG_DT
              FROM   REPORT_MSTR
                     INNER JOIN USER_FLD_MSTR
                             ON REPORT_MSTR.FLD_ID = USER_FLD_MSTR.FLD_ID
              WHERE  				REPORT_MSTR.DEL_YN != 'Y'
              <if test="reportTypes != null">
                  AND 				REPORT_MSTR.REPORT_TYPE IN 
                  <foreach collection="reportTypes" item="type" open="(" close=")" separator=",">
                  #{type}
                  </foreach>
              </if>
              ) ) A
      ORDER  BY UPPERID,
                TYPE,
                ORDINAL
    </select>
</mapper>